(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{147:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return s})),a.d(t,"metadata",(function(){return o})),a.d(t,"rightToc",(function(){return c})),a.d(t,"default",(function(){return p}));var r=a(1),n=a(9),i=(a(0),a(166)),s={id:"script-hooks",title:"Scripting"},o={id:"script-hooks",title:"Scripting",description:"# About Scripting",source:"@site/docs/script-hooks.md",permalink:"/docs/script-hooks",editUrl:"https://github.com/webprofusion/certify-docs/edit/master/docs/script-hooks.md",sidebar:"docs",previous:{title:"About HTTP Validation (http-01)",permalink:"/docs/http-validation"},next:{title:"Using Certificates in Windows",permalink:"/docs/ssl-windows"}},c=[{value:"Scripting Basics",id:"scripting-basics",children:[]},{value:"Pre-Request Script Hooks",id:"pre-request-script-hooks",children:[{value:"Example: Update IIS site root directory dynamically",id:"example-update-iis-site-root-directory-dynamically",children:[]}]},{value:"Post-Request Script Hooks",id:"post-request-script-hooks",children:[{value:"Example: Output the result properties to a text file",id:"example-output-the-result-properties-to-a-text-file",children:[]},{value:"Example: Copy the PFX file to a Central Certificate Store (CCS) as a given user, for multiple domains",id:"example-copy-the-pfx-file-to-a-central-certificate-store-ccs-as-a-given-user-for-multiple-domains",children:[]},{value:"Example: Export certificate using OpenSSL to pem,crt,key etc for Apache (and other services)",id:"example-export-certificate-using-openssl-to-pemcrtkey-etc-for-apache-and-other-services",children:[]},{value:"Example: Send email via Gmail after unsuccessful renewal",id:"example-send-email-via-gmail-after-unsuccessful-renewal",children:[]},{value:"Example: Restart RRAS after successful certificate renewal",id:"example-restart-rras-after-successful-certificate-renewal",children:[]},{value:"Example: Convert CNG certificate storage to CSP (for Exchange 2013)",id:"example-convert-cng-certificate-storage-to-csp-for-exchange-2013",children:[]},{value:"Example: Enable certificate for Exchange 2013 / 2016 services on local server",id:"example-enable-certificate-for-exchange-2013--2016-services-on-local-server",children:[]},{value:"Example: update Remote Desktop Role Certificates",id:"example-update-remote-desktop-role-certificates",children:[]},{value:"Example: Update VMWare Horizon certificate",id:"example-update-vmware-horizon-certificate",children:[]}]},{value:"Troubleshooting",id:"troubleshooting",children:[{value:"Using 64-bit modules",id:"using-64-bit-modules",children:[]}]}],l={rightToc:c};function p(e){var t=e.components,a=Object(n.a)(e,["components"]);return Object(i.b)("wrapper",Object(r.a)({},l,a,{components:t,mdxType:"MDXLayout"}),Object(i.b)("h1",{id:"about-scripting"},"About Scripting"),Object(i.b)("p",null,"Certify is extensible via PowerShell scripts which can be configured to run before or after the Certificate Request (check ",Object(i.b)("inlineCode",{parentName:"p"},"Show Advanced Options")," and open the ",Object(i.b)("inlineCode",{parentName:"p"},"Scripting")," tab). The scripts are provided a parameter ",Object(i.b)("inlineCode",{parentName:"p"},"$result")," which contains the status and details of the managed certificate being requested. You can execute any commands including creating new processes, or using other command line tools."),Object(i.b)("p",null,"A common use for scripting is to use your new certificate for services other than IIS websites, such as Microsoft Exchange, RDP Gateway, FTP servers and other services."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Note: Before v4, the app is 32-bit as is the PowerShell process. See the 64-bit wrapper example below to run 64-bit commands (a common issue if a command is not found). From v4 onwards the PowerShell process is 64-bit.")),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"By default the background service runs as Local System, so your scripts will execute in that context"),", this can be important for issues regarding permissions, file system encryption etc. "),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Do not store scripts under the C:\\Program Files\\CertifyTheWeb","*"," folder. File stored there will be deleted next time you update the app")),Object(i.b)("h2",{id:"scripting-basics"},"Scripting Basics"),Object(i.b)("p",null,"Here is a sample PowerShell script which demonstrates a few commonly accessed pieces of information:"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-PowerShell"}),'param($result)   # required to access the $result parameter\n\n# either $true or $false\n$result.IsSuccess\n\n# object containing all information Certify has about the saved Site\n$result.ManagedItem\n\n# the IIS (or other service) site ID\n$result.ManagedItem.ServerSiteId   # ex: 1, 2, 3, ...\n\n# the website root directory (if applicable)\n$result.ManagedItem.RequestConfig.WebsiteRootPath   # ex: "C:\\inetpub\\wwwroot"\n\n# the path to the created/renewed certificate PFX file\n$result.ManagedItem.CertificatePath   # ex: "C:\\ProgramData\\Certify\\certes\\assets\\pfx\\00f9e07e-83ca-4029-a173-4b704ee78996.pfx"\n\n# the certificate thumbprint\n$result.ManagedItem.CertificateThumbprintHash # ex: "78b1080a1bf5e7fc0bbb0c0614fc4a18932db5f9"\n\n# the previous certificate thumbprint\n$result.ManagedItem.CertificatePreviousThumbprintHash  # ex: "18c1060a1be5e6fc0bbb0c0614fc4a18932db5fa"\n\n# You can set $result.Abort to $true in a pre-request hook to prevent the certificate from\n# being requested (has no effect in post-request hooks)\n$result.Abort = $false\n')),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"$result.ManagedItem")," object is an instance of the ",Object(i.b)("a",{href:"https://github.com/webprofusion/certify/blob/development/src/Certify.Models/Config/ManagedCertificate.cs",target:"_blank"},"ManagedCertificate")," class, so all of the properties it has will be available in your script:"),Object(i.b)("h2",{id:"pre-request-script-hooks"},"Pre-Request Script Hooks"),Object(i.b)("p",null,"Notes: Pre-request scripts are executed immediately before the Certificate Request is about to be made (including the challenge file configuration checks)."),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"The ",Object(i.b)("inlineCode",{parentName:"li"},"$result.IsSuccess")," value will always be ",Object(i.b)("inlineCode",{parentName:"li"},"$false"),"."),Object(i.b)("li",{parentName:"ul"},"If for some reason your script would like to prevent the Certificate Request from being executed, you may set ",Object(i.b)("inlineCode",{parentName:"li"},"$result.Abort")," to ",Object(i.b)("inlineCode",{parentName:"li"},"$true")," and the site your script was executed for will be skipped.")),Object(i.b)("h3",{id:"example-update-iis-site-root-directory-dynamically"},"Example: Update IIS site root directory dynamically"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-PowerShell"}),'param($result)\n$id = $result.ManagedItem.GroupId\n$domain = $result.ManagedItem.RequestConfig.PrimaryDomain\n[xml]$xml = . "$env:windir\\system32\\inetsrv\\appcmd" list config /section:system.applicationHost/sites\n$path = $xml.SelectSingleNode("//site[@id=$id]/application[@path=\'/\']/virtualDirectory/@physicalPath").Value\n$result.ManagedItem.RequestConfig.WebsiteRootPath = $path\nwrite-output "Updated Path [$domain]: $path"\n')),Object(i.b)("h2",{id:"post-request-script-hooks"},"Post-Request Script Hooks"),Object(i.b)("p",null,"Notes: Post-request scripts are executed immediately after the Certificate Request was completed, whether or not the request was successful and the certificate was automatically installed and configured according to the site configuration within Certify."),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"The ",Object(i.b)("inlineCode",{parentName:"li"},"$result.IsSuccess")," value indicates whether or not the Certificate Request was successfully completed."),Object(i.b)("li",{parentName:"ul"},"The ",Object(i.b)("inlineCode",{parentName:"li"},"$result.Message")," value provides a message describing the reason for failure, or a message indicating success")),Object(i.b)("h3",{id:"example-output-the-result-properties-to-a-text-file"},"Example: Output the result properties to a text file"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-PowerShell"}),'# Logs results to the given path (modify as required)\n\nparam($result)  \n$logpath = "c:\\temp\\ps-test.txt"\n\n$date = Get-Date\n\nAdd-Content $logpath ("-------------------------------------------------");\nAdd-Content $logpath ("Script Run Date: " + $date)\nAdd-Content $logpath ($result | ConvertTo-Json)\n')),Object(i.b)("h3",{id:"example-copy-the-pfx-file-to-a-central-certificate-store-ccs-as-a-given-user-for-multiple-domains"},"Example: Copy the PFX file to a Central Certificate Store (CCS) as a given user, for multiple domains"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-PowerShell"}),'# example script to copy the output PFX to a UNC path for Central Certificate Store\n# Enabling CCS: https://techcommunity.microsoft.com/t5/iis-support-blog/central-certificate-store-ccs-with-iis/ba-p/377274\n$result = Get-Content -Raw -Path C:\\temp\\ps-test.json | ConvertFrom-Json\n\n$ccsPath="\\\\myserver\\ccs"\n\nif ($result.IsSuccess -eq $true) {\n\n    # connect network share with credentials\n    net use $ccsPath /USER:myserver\\ccsuser password1\n\n    # example file copy where cert contains webmail.example.com and autodiscover.example.com domains\n    Copy-Item -Path $result.ManagedItem.CertificatePath -Destination $ccsPath\\webmail.example.com.pfx -Force\n    Copy-Item -Path $result.ManagedItem.CertificatePath -Destination $ccsPath\\autodiscover.example.com.pfx -Force\n\n    # disconnect network share\n    net use $ccsPath /delete\n}\n')),Object(i.b)("h3",{id:"example-export-certificate-using-openssl-to-pemcrtkey-etc-for-apache-and-other-services"},"Example: Export certificate using OpenSSL to pem,crt,key etc for Apache (and other services)"),Object(i.b)("p",null,"Many services such as Apache, nginx and some mail servers etc work with certificates as pem or other formats. These generally need you to export the certificate and related public and private keys. The easiest way to do this is to install OpenSSL then use that to convert your PFX format certificate."),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-PowerShell"}),'param($result)\n\n# script example adapted from https://community.certifytheweb.com/t/filezilla-server-ps-script/141/8\n\n# Alias to your OpenSSL install\nset-alias opensslcmd "C:\\Tools\\OpenSSL\\openssl.exe" \n\n# Set paths to where keys will be saved. \n# This will vary depending on your required configuration. File name are not that important but your config must point to the same filenames.\n\n$keypath = "C:\\apache\\conf\\mydomain.com\\"\n$key = $keypath + "cert.key"\n$rsakey = $keypath + "cert_rsa.key"\n$pem = $keypath + "cert.pem"\n\n# Get the latest PFX file path\n$sourcepfx = $result.ManagedItem.CertificatePath\n\n# Create the Key, RSA Key, and PEM file. Use the RSA Key & PEM for FileZilla\nopensslcmd pkcs12 -in $sourcepfx -out $key -nocerts -nodes -passin pass:\nopensslcmd rsa -in $key -out $rsakey\nopensslcmd pkcs12 -in $sourcepfx -out $pem -nokeys -clcerts -passin pass:\n\n# optional: restart the Apache service (example)\nRestart-Service -Name Apache2.4 -Force\n')),Object(i.b)("h3",{id:"example-send-email-via-gmail-after-unsuccessful-renewal"},"Example: Send email via Gmail after unsuccessful renewal"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Note: this is an example only, by default the app will use the certifytheweb.com API to notify you of repeated failures.")),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-PowerShell"}),'param($result)\nif (!$result.IsSuccess) {\n   $EmailFrom = "username@gmail.com"\n   $EmailTo = "username@gmail.com"\n   $Subject = "Cert Request Failed: " + $result.ManagedItem.RequestConfig.PrimaryDomain\n   $Body = "Error: " + $result.Message\n   $SMTPServer = "smtp.gmail.com"\n   $SMTPClient = New-Object Net.Mail.SmtpClient($SmtpServer, 587)\n   $SMTPClient.EnableSsl = $true\n   $SMTPClient.Credentials = New-Object System.Net.NetworkCredential("username@gmail.com", "password");\n   $SMTPClient.Send($EmailFrom, $EmailTo, $Subject, $Body)\n   write-output "Sent notification email"\n}\n')),Object(i.b)("h3",{id:"example-restart-rras-after-successful-certificate-renewal"},"Example: Restart RRAS after successful certificate renewal"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-PowerShell"}),'param($result)\nif ($result.IsSuccess -and $result.ManagedItem.GroupId -eq 1) {\n   write-output "Restarting RRAS..."\n   Net Stop RemoteAccess\n   Net Start RemoteAccess\n   write-output "Done"\n}\n')),Object(i.b)("h3",{id:"example-convert-cng-certificate-storage-to-csp-for-exchange-2013"},"Example: Convert CNG certificate storage to CSP (for Exchange 2013)"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-PowerShell"}),'param($result)\n$tempfile = "$env:TEMP\\CertifyTemp.pfx"\n$pfx = get-pfxcertificate -filepath $result.ManagedItem.CertificatePath\ncertutil -f -p Certify -exportpfx $pfx.SerialNumber $tempfile\ncertutil -delstore my $pfx.SerialNumber\ncertutil -p Certify -csp "Microsoft RSA SChannel Cryptographic Provider" -importpfx $tempfile\nremove-item $tempfile\n')),Object(i.b)("h3",{id:"example-enable-certificate-for-exchange-2013--2016-services-on-local-server"},"Example: Enable certificate for Exchange 2013 / 2016 services on local server"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-PowerShell"}),"param($result)\nEnable-ExchangeCertificate -Thumbprint $result.ManagedItem.CertificateThumbprintHash -Services POP,IMAP,SMTP,IIS -Force\n")),Object(i.b)("h3",{id:"example-update-remote-desktop-role-certificates"},"Example: update Remote Desktop Role Certificates"),Object(i.b)("p",null,"This example assumes it's starting in a 32-bit instance and switches to the 64-bit powershell to import the 64-bit RemoteDesktop module. V4.x onwards of the app is 64-bit only."),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-PowerShell"}),'param($result)\nset-alias ps64 "$env:windir\\sysnative\\WindowsPowerShell\\v1.0\\powershell.exe"\nps64 -args $result -command {\n   $result = $args[0]\n   $pfxpath = $result.ManagedItem.CertificatePath\n   Import-Module RemoteDesktop\n   Set-RDCertificate -Role RDPublishing -ImportPath $pfxpath -Force\n   Set-RDCertificate -Role RDWebAcces -ImportPath $pfxpath -Force\n   Set-RDCertificate -Role RDGateway -ImportPath $pfxpath -Force\n   Set-RDCertificate -Role RDRedirector -ImportPath $pfxpath -Force\n}\n')),Object(i.b)("h3",{id:"example-update-vmware-horizon-certificate"},"Example: Update VMWare Horizon certificate"),Object(i.b)("p",null,"This example removes any previous certificate with the same FriendlyName (",Object(i.b)("inlineCode",{parentName:"p"},"vdm"),") then renames the Friendly Name property of the new certificate to ",Object(i.b)("inlineCode",{parentName:"p"},"vmd"),". It then restarts the ",Object(i.b)("inlineCode",{parentName:"p"},"wstunnel")," service."),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-PowerShell"}),'param($result)\n\nif ($result.IsSuccess) {\n\n   $thumbprint = $result.ManagedItem.CertificateThumbprintHash # e.g. 2c127d49b4f63d947dd7b91750c9e57751eced0c\n\n   # remove the old cert (by Friendly Name \'vdm\') to avoid duplication, if it exists\n   Get-ChildItem -Path cert:\\LocalMachine\\My | Where {$_.FriendlyName.Equals("vdm")} | Remove-Item\n\n   # rename our new certificate\n   $cert = Get-ChildItem -Path cert:\\LocalMachine\\My$thumbprint\n\n   $cert.FriendlyName ="vdm"\n\n   # restart the wstunnel service to apply certificate\n   Restart-Service wstunnel -Force -ErrorAction Stop\n}\n\n')),Object(i.b)("h4",{id:"example-update-certificate-for-sstp-vpn"},"Example: Update certificate for SSTP VPN"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-PowerShell"}),"\n\nparam($result)\n\n# Store certificate in variable\n$cert = Get-ChildItem -Path Cert:\\LocalMachine\\My | Where-Object {$_.Thumbprint -match $result.ManagedItem.CertificateThumbprintHash}\n\n# Stop RRAS, set cert, start RRAS\nImport-Module RemoteAccess\nStop-Service RemoteAccess\nSet-RemoteAccess -SslCertificate $cert\nStart-Service RemoteAccess\n")),Object(i.b)("h2",{id:"troubleshooting"},"Troubleshooting"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},'In the Certify UI, you may test scripts by clicking the "Test" button after entering the script filename for the hook you would like to test. This currently runs as your user account whereas the real renewal script will happen as Local System.'),Object(i.b)("li",{parentName:"ul"},"For a testing pre-request script, the ",Object(i.b)("inlineCode",{parentName:"li"},"$result.IsSuccess")," value will be ",Object(i.b)("inlineCode",{parentName:"li"},"$false"),", and for a post-request script the value will be ",Object(i.b)("inlineCode",{parentName:"li"},"$true"),"."),Object(i.b)("li",{parentName:"ul"},"The ",Object(i.b)("inlineCode",{parentName:"li"},"$result.ManagedItem.CertificatePath")," value will be set to the filename (including path) of the PFX file containing the requested certificate, unless the site is new and has not had a successful Certificate Request, in which case the value will not be set.")),Object(i.b)("h3",{id:"using-64-bit-modules"},"Using 64-bit modules"),Object(i.b)("p",null,"If you attempt to import a module with ",Object(i.b)("a",Object(r.a)({parentName:"p"},{href:"https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/import-module?view=powershell-5.1"}),Object(i.b)("inlineCode",{parentName:"a"},"Import-Module"))," that does not run in 32-bit mode (i.e. RemoteDesktop), you may receive an error like ",Object(i.b)("inlineCode",{parentName:"p"},"\"Import-Module : The specified module 'RemoteDesktop' was not loaded because no valid module file was found in any module directory.\""),". To load a 64-bit module you can use this snippet to pass the ",Object(i.b)("inlineCode",{parentName:"p"},"$result")," object to a script running in 64-bit powershell:"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-powershell"}),'param($result)\nset-alias ps64 "$env:windir\\sysnative\\WindowsPowerShell\\v1.0\\powershell.exe"\nps64 -args $result -command {\n   $result = $args[0]\n   write-output $result.IsSuccess\n   import-module -name RemoteDesktop\n   Set-RDCertificate ...\n}\n')))}p.isMDXComponent=!0},166:function(e,t,a){"use strict";a.d(t,"a",(function(){return u})),a.d(t,"b",(function(){return b}));var r=a(0),n=a.n(r);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},i=Object.keys(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=n.a.createContext({}),p=function(e){var t=n.a.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o({},t,{},e)),a},u=function(e){var t=p(e.components);return n.a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.a.createElement(n.a.Fragment,{},t)}},d=Object(r.forwardRef)((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),u=p(a),d=r,b=u["".concat(s,".").concat(d)]||u[d]||m[d]||i;return a?n.a.createElement(b,o({ref:t},l,{components:a})):n.a.createElement(b,o({ref:t},l))}));function b(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,s=new Array(i);s[0]=d;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:r,s[1]=o;for(var l=2;l<i;l++)s[l]=a[l];return n.a.createElement.apply(null,s)}return n.a.createElement.apply(null,a)}d.displayName="MDXCreateElement"}}]);